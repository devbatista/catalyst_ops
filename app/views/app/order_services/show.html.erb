<div class="page-wrapper">
  <div class="page-content">
    <div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3 justify-content-between">
      <h4 class="mb-0 text-uppercase">Detalhes da Ordem de Serviço</h4>
      <%= link_to "Gerar PDF", generate_pdf_app_order_service_path(@order_service), class: "btn btn-outline-secondary", target: "_blank" %>
    </div>

    <% flash.each do |type, message| %>
    <% bootstrap_class = { notice: "alert-success", alert: "alert-danger", error: "alert-danger" }[type.to_sym] || "alert-info" %>
    <div class="alert <%= bootstrap_class %> alert-dismissible fade show" role="alert">
      <%= message %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <% end %>

    <div class="card">
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-4">
            <strong>ID:</strong>
            <p><%= @order_service.id %></p>
          </div>
          <div class="col-md-3">
            <strong>Código:</strong>
            <p><%= @order_service.code %></p>
          </div>
          <div class="col-md-5">
            <strong>Cliente:</strong>
            <p><%= @order_service.client&.name %></p>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-2">
            <strong>Status:</strong>
            <p><%= @order_service.status.humanize %></p>
          </div>
          <div class="col-md-2">
            <strong>Agendada para:</strong>
            <p><%= l(@order_service.scheduled_at, format: :short) if @order_service.scheduled_at %></p>
          </div>
          <div class="col-md-2">
            <strong>Previsão de término:</strong>
            <p><%= l(@order_service.expected_end_at, format: :short) if @order_service.expected_end_at %></p>
          </div>
          <div class="col-md-3">
            <strong>Técnicos:</strong>
            <p>
              <%= @order_service.assignments.map { |a| a.user.name }.join(", ") %>
            </p>
          </div>
          <div class="col-md-3">
            <strong>Criada em:</strong>
            <p><%= l(@order_service.created_at, format: :short) %></p>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-12">
            <strong>Titulo:</strong>
            <p><%= @order_service.title %></p>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-12">
            <strong>Descrição:</strong>
            <p><%= @order_service.description %></p>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-12">
            <strong>Observações:</strong>
            <div class="form-control-plaintext">
              <%= @order_service.observations.presence || "Nenhuma observação." %>
            </div>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-12">
            <strong>Anexos:</strong>
            <% if @order_service.attachments.attached? %>
            <ul>
              <% @order_service.attachments.each do |attachment| %>
              <li>
                <%= link_to attachment.filename, url_for(attachment), target: "_blank" %>
                (<%= number_to_human_size(attachment.byte_size) %>)
              </li>
              <% end %>
            </ul>
            <% else %>
            <span>Nenhum anexo.</span>
            <% end %>
          </div>
        </div>
        <hr>
        <h5>Itens do Serviço</h5>
        <% if @service_items.any? %>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Descrição</th>
              <th>Quantidade</th>
              <th>Valor Unitário</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <% @service_items.each do |item| %>
            <tr>
              <td><%= item.description %></td>
              <td><%= item.quantity %></td>
              <td><%= currency_br(item.unit_price) %></td>
              <td><%= currency_br(item.quantity * item.unit_price) %></td>
            </tr>
            <% end %>
          </tbody>
        </table>
        <% else %>
        <p>Nenhum item cadastrado para esta ordem de serviço.</p>
        <% end %>
        <div class="mt-3 d-flex justify-content-between align-items-center">
          <div>
            <%= link_to "Voltar", app_order_services_path, class: "btn btn-secondary" %>
            <%= link_to "Editar", edit_app_order_service_path(@order_service), class: "btn btn-primary" %>
          </div>
          <div>
            <% if @order_service.atrasada? %>
            <%= button_to "Reagendar",
                    schedule_app_order_service_path(@order_service),
                    class: "btn btn-#{OrderService.new(status: 'agendada').status_color} btn-sm ms-2",
                    method: :get %>
            <% else %>
              <% @order_service.available_actions.each do |action| %>
              <% if @order_service.pendente? %>
              <%= button_to "Agendar",
                      schedule_app_order_service_path(@order_service),
                      class: "btn btn-#{OrderService.new(status: 'agendada').status_color} btn-sm ms-2",
                      form_class: "d-inline-block",
                      method: :get %>
              <% end %>
              <%= button_to action[:label],
                      update_status_app_order_service_path(@order_service, status: action[:target_status]),
                      class: "btn btn-#{OrderService.new(status: action[:target_status]).status_color} btn-sm ms-2",
                      form_class: "d-inline-block",
                      method: :patch,
                      data: { confirm: "Tem certeza que deseja '#{action[:label]}' esta OS?" } %>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>