<%= form_with(model: @order_service, 
              url: app_order_services_path,
              local: true) do |f| %>
<div class="row g-3">
  <div class="row mb-3 mt-3">
    <div class="col-md-6">
      <%= f.label :client_id, "Cliente", class: "form-label" %>
      <%= f.collection_select :client_id, @clients, :id, :name, { prompt: "Selecione o cliente" }, class: "form-select" %>
    </div>
    <div class="col-md-3">
      <%= f.label :scheduled_at, "Data agendada", class: "form-label" %>
      <%= f.text_field :scheduled_at, class: "form-control", type: "datetime-local", value: (@order_service.scheduled_at&.strftime("%Y-%m-%dT%H:%M") if @order_service.scheduled_at) %>
    </div>
    <div class="col-md-3">
      <%= f.label :status, "Status", class: "form-label" %>
      <%= f.select :status, OrderService.statuses.keys.map { |s| [s.humanize, s] }, {}, class: "form-select" %>
    </div>
  </div>
  <div class="row mb-3">
    <div class="col-md-12">
      <%= f.label :title, "Título", class: "form-label" %>
      <%= f.text_field :title, class: "form-control" %>
    </div>
  </div>
  <div class="row mb-3">
    <div class="col-md-12">
      <%= f.label :description, "Descrição", class: "form-label" %>
      <%= f.text_area :description, class: "form-control", rows: 3 %>
    </div>
  </div>
  <div class="row mb-3">
    <div class="col-md-6">
      <%= f.label :attachments, "Anexos", class: "form-label" %>
      <%= f.file_field :attachments, multiple: true, class: "form-control" %>
      <% if @order_service.attachments.attached? %>
      <div class="mt-2">
        <strong>Anexos atuais:</strong>
        <ul>
          <% @order_service.attachments.each do |attachment| %>
          <li>
            <%= link_to attachment.filename, url_for(attachment), target: "_blank" %>
          </li>
          <% end %>
        </ul>
      </div>
      <% end %>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-12">
      <%= f.label :user_ids, "Técnicos atribuídos", class: "form-label" %>
      <%= f.collection_select :user_ids,
                                @technicians,
                                :id,
                                :name,
                                {
                                  prompt: "Selecione os técnicos",
                                  selected: @order_service.user_ids 
                                },
                                {
                                  multiple: true,
                                  class: "form-select",
                                  id: "multiple-select-field",
                                  data: {
                                    placeholder: "Escolha os técnicos"
                                  }
                                } %>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12 mt-3">
      <%= f.submit "Salvar", class: "btn btn-primary px-4" %>
      <%= link_to "Voltar", app_order_services_path, class: "btn btn-light px-4" %>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    if (window.jQuery) {
      $('#multiple-select-field').select2({
        theme: 'bootstrap-4',
        placeholder: $('#multiple-select-field').data('placeholder'),
        width: '100%'
      });
    } else {
      console.error("jQuery não está disponível!");
    }
  });
</script>
<% end %>